# FlashClaw 设计要求

设计决策和架构概述。

---

## 为什么存在

FlashClaw 是一个轻量级的个人 AI 助手。单个 Node.js 进程，乐高式插件架构，AI 代理直接在宿主机运行。

---

## 设计理念

### 小到可以理解

整个代码库应该是你能阅读和理解的。一个 Node.js 进程，几个源文件。没有微服务，没有消息队列，没有抽象层。

### 乐高式插件架构

- **渠道插件**：飞书、钉钉、Telegram 等
- **工具插件**：发消息、定时任务、自定义工具
- **热加载**：运行时加载/卸载，无需重启

### 为单用户构建

这不是框架或平台。是满足特定需求的工作软件。Fork 它，添加你实际想要的集成。

### 自定义 = 添加插件

想要新功能？在 `plugins/` 目录添加插件。想要新平台？添加渠道插件。核心代码保持稳定，扩展通过插件完成。

### AI 原生开发

我不需要安装向导 - Claude Code 指导安装。我不需要监控仪表板 - 我问 Claude Code 发生了什么。我不需要精心设计的日志 UI - 我让 Claude 读日志。我不需要调试工具 - 我描述问题，Claude 修复它。

---

## 愿景

一个可通过消息平台访问的个人 AI 助手，最少的自定义代码。

**核心组件：**
- **直接 API 调用** 作为 AI 引擎
- **飞书/钉钉** 作为主要 I/O 渠道（WebSocket 长连接）
- **持久记忆** 每个对话和全局
- **定时任务** 运行代理并可以发回消息
- **网络访问** 用于搜索和浏览

**实现方法：**
- 使用现有工具（消息 SDK、AI API）
- 最少的胶水代码
- 尽可能使用基于文件的系统（CLAUDE.md 用于记忆，文件夹用于群组）

---

## 环境要求

### 运行时

| 要求 | 版本 | 说明 |
|------|------|------|
| Node.js | 20+ | 运行时环境 |
| npm | 10+ | 包管理器（随 Node.js 安装） |

### 平台支持

| 平台 | 状态 | 备注 |
|------|------|------|
| Windows | ✅ 支持 | 原生运行 |
| Linux | ✅ 支持 | 任何主流发行版 |
| macOS | ✅ 支持 | Intel 或 Apple Silicon |

### 消息平台

至少配置一个：

| 平台 | 凭证 | 连接方式 |
|------|------|----------|
| 飞书 | `FEISHU_APP_ID`, `FEISHU_APP_SECRET` | WebSocket 长连接 |
| 钉钉 | `DINGTALK_APP_KEY`, `DINGTALK_APP_SECRET` | Stream API |

**注意**：所有平台都使用长连接，无需公网服务器！

### AI 认证

选择其一：

| 方式 | 环境变量 |
|------|----------|
| Anthropic 官方 | `ANTHROPIC_API_KEY` |
| API 代理 | `ANTHROPIC_BASE_URL`, `ANTHROPIC_AUTH_TOKEN`, `AI_MODEL` |

---

## 架构决策

### 插件系统

FlashClaw 采用乐高式插件架构：

| 插件类型 | 说明 | 示例 |
|----------|------|------|
| `channel` | 消息渠道 | 飞书、钉钉 |
| `tool` | AI 工具 | 发消息、定时任务 |

**插件加载流程：**
1. 扫描 `plugins/` 目录
2. 读取 `plugin.json` 获取元信息
3. 动态加载 `index.ts`
4. 注册到插件管理器

**热加载：**
- 工具插件：完整卸载/重载
- 渠道插件：完整重启（断开重连）

### 消息路由

- 路由器监听消息平台并根据配置路由消息
- **自动注册**：新会话自动注册，无需手动配置
- 触发：群聊需要 @提及，私聊直接响应
- 消息去重：相同消息 ID 不重复处理

### 记忆系统

- **群组记忆**：每个群组有自己的文件夹和 `CLAUDE.md`
- **全局记忆**：`groups/global/CLAUDE.md` 被所有群组读取
- **文件**：群组可以在其文件夹中创建/读取文件并引用它们

### 会话管理

- 每个群组维护一个对话会话
- 上下文包含最近 N 条消息历史
- 记忆系统提供长期上下文

### 直接执行

- AI 代理直接在宿主机运行
- 可以执行 Bash 命令、读写文件
- 这是个人助手的设计选择，不需要容器隔离

### 定时任务

- 用户可以从任何群组让 AI 安排重复或一次性任务
- 任务作为完整代理在创建它们的群组上下文中运行
- 任务可以使用 `send_message` 工具向群组发送消息，或静默完成
- 调度类型：cron 表达式、间隔（毫秒）或一次性（ISO 时间戳）

### 模型能力检测

FlashClaw 自动检测 AI 模型的能力：

| 能力 | 说明 |
|------|------|
| 文本输入 | 所有模型支持 |
| 图片输入 | Claude、GPT-4o 等支持 |
| 音频输入 | 部分模型支持 |
| 视频输入 | Gemini 等支持 |

如果用户发送图片但模型不支持，会提示用户。

---

## 集成点

### 消息平台

- 使用官方 SDK 的 WebSocket/Stream 长连接
- 无需公网服务器/webhook
- 消息存储在 SQLite

### 定时任务

- 内置调度器运行定时任务
- 工具插件提供调度能力
- 工具：`schedule_task`、`list_tasks`、`cancel_task`、`pause_task`、`resume_task`、`send_message`
- 任务存储在 SQLite，包含运行历史
- 调度器循环每分钟检查到期任务

### "正在思考" 提示

当 AI 响应较慢时：
1. 先发送"正在思考..."占位消息
2. AI 响应后更新/替换占位消息
3. 提升用户体验

---

## 设置和自定义

### CLI 初始化

```bash
flashclaw init
```

交互式引导配置：
- 选择消息平台（飞书/钉钉/两者）
- 输入应用凭证
- 设置机器人名称

### 添加新功能

1. 在 `plugins/` 创建插件目录
2. 添加 `plugin.json` 和 `index.ts`
3. 运行 `flashclaw plugins reload`

### 部署

- 通过 `flashclaw start -d` 后台运行
- 或使用 PM2、systemd、launchd 管理

---

## 项目名称

**FlashClaw** - 闪电龙虾，快速、轻量级的 AI 助手。
