# FlashClaw 设计要求

设计决策和架构概述。

---

## 为什么存在

FlashClaw 是一个轻量级的个人 AI 助手。单个 Node.js 进程，几个源文件，AI 代理直接在宿主机运行。

---

## 设计理念

### 小到可以理解

整个代码库应该是你能阅读和理解的。一个 Node.js 进程，几个源文件。没有微服务，没有消息队列，没有抽象层。

### 为单用户构建

这不是框架或平台。是满足特定需求的工作软件。Fork 它，添加你实际想要的集成。

### 自定义 = 修改代码

没有配置膨胀。如果你想要不同的行为，修改代码。代码库足够小，这样做是安全和实用的。只有触发词等极少数东西在配置中。其他一切 - 直接修改代码来实现你想要的。

### AI 原生开发

我不需要安装向导 - Claude Code 指导安装。我不需要监控仪表板 - 我问 Claude Code 发生了什么。我不需要精心设计的日志 UI - 我让 Claude 读日志。我不需要调试工具 - 我描述问题，Claude 修复它。

代码库假设你有一个 AI 协作者。它不需要过度自文档化或自调试，因为 Claude 总是在那里。

### 技能优于功能

当人们贡献时，他们应该贡献能转换代码库的技能。用户 fork 仓库，运行技能来自定义，最终得到干净的代码，完全符合他们的需求。

---

## 愿景

一个可通过消息平台访问的个人 AI 助手，最少的自定义代码。

**核心组件：**
- **AI Agent SDK** 作为核心代理
- **飞书/钉钉** 作为主要 I/O 渠道（WebSocket 长连接）
- **持久记忆** 每个对话和全局
- **定时任务** 运行代理并可以发回消息
- **网络访问** 用于搜索和浏览

**实现方法：**
- 使用现有工具（消息连接器、Claude Agent SDK、MCP 服务器）
- 最少的胶水代码
- 尽可能使用基于文件的系统（CLAUDE.md 用于记忆，文件夹用于群组）

---

## 环境要求

### 运行时

| 要求 | 版本 | 说明 |
|------|------|------|
| Node.js | 20+ | 运行时环境 |
| npm | 10+ | 包管理器（随 Node.js 安装） |

### 平台支持

| 平台 | 状态 | 备注 |
|------|------|------|
| Windows | ✅ 支持 | 原生或 WSL2 |
| Linux | ✅ 支持 | 任何主流发行版 |
| macOS | ✅ 支持 | Intel 或 Apple Silicon |

### 消息平台

至少配置一个：

| 平台 | 凭证 | 连接方式 |
|------|------|----------|
| 飞书 | `FEISHU_APP_ID`, `FEISHU_APP_SECRET` | WebSocket 长连接 |
| 钉钉 | `DINGTALK_APP_KEY`, `DINGTALK_APP_SECRET` | Stream API |

**注意**：所有平台都使用长连接，无需公网服务器！

### Claude 认证

选择其一：

| 方式 | 环境变量 |
|------|----------|
| Claude 订阅 | `CLAUDE_CODE_OAUTH_TOKEN` |
| API Key | `ANTHROPIC_API_KEY` |
| API 代理 | `ANTHROPIC_BASE_URL`, `ANTHROPIC_AUTH_TOKEN`, `ANTHROPIC_MODEL` |

---

## 架构决策

### 消息路由
- 路由器监听消息平台并根据配置路由消息
- 只处理已注册群组的消息
- 触发：智能检测（@提及、问句、请求动词等）
- 未注册群组完全忽略

### 记忆系统
- **群组记忆**：每个群组有自己的文件夹和 `CLAUDE.md`
- **全局记忆**：`groups/global/CLAUDE.md` 被所有群组读取，但只有"main"（自聊天）可写
- **文件**：群组可以在其文件夹中创建/读取文件并引用它们
- 代理在群组文件夹中运行，自动继承两个 CLAUDE.md 文件

### 会话管理
- 每个群组维护一个对话会话（通过 Claude Agent SDK）
- 上下文太长时会话自动压缩，保留关键信息

### 直接执行
- AI 代理直接在宿主机运行
- 可以执行 Bash 命令、读写文件
- 这是个人助手的设计选择，不需要容器隔离

### 定时任务
- 用户可以从任何群组让 Claude 安排重复或一次性任务
- 任务作为完整代理在创建它们的群组上下文中运行
- 任务可以访问所有工具包括 Bash
- 任务可以选择通过 `send_message` 工具向群组发送消息，或静默完成
- 任务运行记录到数据库，包含持续时间和结果
- 调度类型：cron 表达式、间隔（毫秒）或一次性（ISO 时间戳）
- 从 main：可以为任何群组安排任务，查看/管理所有任务
- 从其他群组：只能管理该群组的任务

### 群组管理
- 新群组通过主频道明确添加
- 群组通过编辑 `data/registered_groups.json` 注册
- 每个群组在 `groups/` 下获得专用文件夹

### 主频道权限
- 主频道是管理员/控制群组（通常是自聊天）
- 可以写入全局记忆（`groups/global/CLAUDE.md`）
- 可以为任何群组安排任务
- 可以查看和管理所有群组的任务

---

## 集成点

### 消息平台
- 使用官方 SDK 的 WebSocket/Stream 长连接
- 无需公网服务器/webhook
- 消息存储在 SQLite

### 调度器
- 内置调度器运行定时任务
- 自定义 `flashclaw` MCP 服务器提供调度工具
- 工具：`schedule_task`、`list_tasks`、`pause_task`、`resume_task`、`cancel_task`、`send_message`
- 任务存储在 SQLite，包含运行历史
- 调度器循环每分钟检查到期任务
- 任务在群组上下文中执行 AI Agent SDK

### 网络访问
- 内置 WebSearch 和 WebFetch 工具
- 标准 Claude Agent SDK 能力

---

## 设置和自定义

### 理念
- 最少的配置文件
- 通过 Claude Code 完成设置和自定义
- 用户克隆仓库并运行 Claude Code 来配置
- 每个用户获得符合其确切需求的自定义设置

### 技能
- `/setup` - 安装依赖、配置消息平台、启动服务
- `/customize` - 通用技能，用于添加功能（新渠道如 Telegram、新集成、行为更改）
- `/add-dingtalk` - 添加钉钉平台支持

### 部署
- 通过 systemd（Linux/WSL2）或 launchd（macOS）或 PM2（Windows）运行
- 单个 Node.js 进程处理所有事情

---

## 项目名称

**FlashClaw** - 快速、轻量级的 AI 助手。
